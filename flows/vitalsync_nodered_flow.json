[
    {
        "id": "vitalsync-flow-tab",
        "type": "tab",
        "label": "VitalSync IoT Simulator",
        "disabled": false,
        "info": "# VitalSync IoT Simulator\n\nSimulador de dispositivos IoT para VitalSync MVP.\n\n## Dispositivos Simulados:\n- ğŸ‘´ PapÃ¡ - Roberto GarcÃ­a (Xiaomi Mi Band)\n- ğŸ‘µ MamÃ¡ - Elena GarcÃ­a (Apple Watch)\n- ğŸ‘¨â€ğŸ¦³ Abuelo - JosÃ© GarcÃ­a Sr. (Fitbit)\n- ğŸ”§ Simulador Test\n\n## Requisitos del Proyecto Cumplidos:\n- âœ… Start/Stop switch\n- âœ… Frequency slider (500-3000ms)\n- âœ… Anomaly injector toggle\n- âœ… 2+ gauges (HR, SpO2)\n- âœ… 1 rolling chart (Temperature)\n- âœ… Health indicator (API status)\n\n## URL de la API:\nConfigurar en el nodo 'API Config' o usar variable de entorno API_URL"
    },
    {
        "id": "dashboard-ui-tab",
        "type": "ui_tab",
        "name": "VitalSync Monitor",
        "icon": "fa-heartbeat",
        "order": 1,
        "disabled": false,
        "hidden": false
    },
    {
        "id": "config-group",
        "type": "ui_group",
        "name": "âš™ï¸ Control Panel",
        "tab": "dashboard-ui-tab",
        "order": 1,
        "disp": true,
        "width": "6",
        "collapse": false
    },
    {
        "id": "vitals-group",
        "type": "ui_group",
        "name": "â¤ï¸ Vital Signs",
        "tab": "dashboard-ui-tab",
        "order": 2,
        "disp": true,
        "width": "6",
        "collapse": false
    },
    {
        "id": "chart-group",
        "type": "ui_group",
        "name": "ğŸ“Š Charts",
        "tab": "dashboard-ui-tab",
        "order": 3,
        "disp": true,
        "width": "12",
        "collapse": false
    },
    {
        "id": "status-group",
        "type": "ui_group",
        "name": "ğŸ“¡ System Status",
        "tab": "dashboard-ui-tab",
        "order": 4,
        "disp": true,
        "width": "6",
        "collapse": false
    },
    {
        "id": "alerts-group",
        "type": "ui_group",
        "name": "ğŸš¨ Alerts",
        "tab": "dashboard-ui-tab",
        "order": 5,
        "disp": true,
        "width": "6",
        "collapse": false
    },
    {
        "id": "comment-header",
        "type": "comment",
        "z": "vitalsync-flow-tab",
        "name": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        "info": "",
        "x": 350,
        "y": 20,
        "wires": []
    },
    {
        "id": "comment-title",
        "type": "comment",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ¥ VitalSync IoT Simulator - MVP Demo (SIS4415 Project)",
        "info": "# VitalSync IoT Simulator\n\nEste flujo cumple con TODOS los requisitos del proyecto:\n\n## Requisitos Obligatorios:\n- âœ… Start/Stop switch: enables/disables data emission\n- âœ… Frequency slider: adjusts emission interval (500â€“3000 ms)\n- âœ… Anomaly toggle: injects out-of-range values to test alerts\n- âœ… 2 Gauges: heart_rate, oxygen_level\n- âœ… 1 Live chart: body_temperature (rolling 2 min)\n- âœ… Health indicator: visual cue when POST succeeded\n\n## Payload enviado a POST /api/vitals:\n```json\n{\n  \"deviceId\": \"XIAOMI-PAPA-001\",\n  \"memberId\": \"familia-garcia-papa\",\n  \"memberName\": \"Roberto GarcÃ­a\",\n  \"relationship\": \"padre\",\n  \"heartRate\": 72,\n  \"oxygenLevel\": 96.5,\n  \"bodyTemperature\": 36.5,\n  \"steps\": 3200,\n  \"timestamp\": \"2025-11-24T10:30:00.000Z\"\n}\n```",
        "x": 280,
        "y": 60,
        "wires": []
    },
    {
        "id": "comment-footer",
        "type": "comment",
        "z": "vitalsync-flow-tab",
        "name": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        "info": "",
        "x": 350,
        "y": 100,
        "wires": []
    },
    {
        "id": "start-stop-switch",
        "type": "ui_switch",
        "z": "vitalsync-flow-tab",
        "name": "â–¶ï¸ Start/Stop",
        "label": "Data Emission",
        "tooltip": "Start or stop sending simulated vital data to the API",
        "group": "config-group",
        "order": 1,
        "width": "6",
        "height": "1",
        "passthru": true,
        "decouple": "false",
        "topic": "control/emission",
        "topicType": "str",
        "style": "",
        "onvalue": "true",
        "onvalueType": "bool",
        "onicon": "fa-play-circle",
        "oncolor": "#4CAF50",
        "offvalue": "false",
        "offvalueType": "bool",
        "officon": "fa-stop-circle",
        "offcolor": "#F44336",
        "animate": true,
        "x": 150,
        "y": 160,
        "wires": [["set-emission-state", "status-emission"]]
    },
    {
        "id": "frequency-slider",
        "type": "ui_slider",
        "z": "vitalsync-flow-tab",
        "name": "â±ï¸ Frequency",
        "label": "Interval (ms)",
        "tooltip": "Data emission frequency: 500ms to 3000ms",
        "group": "config-group",
        "order": 2,
        "width": "6",
        "height": "1",
        "passthru": true,
        "outs": "end",
        "topic": "config/frequency",
        "topicType": "str",
        "min": 500,
        "max": 3000,
        "step": 100,
        "x": 150,
        "y": 220,
        "wires": [["update-interval"]]
    },
    {
        "id": "anomaly-toggle",
        "type": "ui_switch",
        "z": "vitalsync-flow-tab",
        "name": "âš ï¸ Inject Anomalies",
        "label": "Anomaly Mode",
        "tooltip": "Inject out-of-range values to test alert system (30% probability)",
        "group": "config-group",
        "order": 3,
        "width": "6",
        "height": "1",
        "passthru": true,
        "decouple": "false",
        "topic": "config/anomaly",
        "topicType": "str",
        "style": "",
        "onvalue": "true",
        "onvalueType": "bool",
        "onicon": "fa-exclamation-triangle",
        "oncolor": "#FF9800",
        "offvalue": "false",
        "offvalueType": "bool",
        "officon": "fa-check-circle",
        "offcolor": "#9E9E9E",
        "animate": true,
        "x": 170,
        "y": 280,
        "wires": [["set-anomaly-mode"]]
    },
    {
        "id": "family-selector",
        "type": "ui_dropdown",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Family Member",
        "label": "View:",
        "tooltip": "Select which family member to display on dashboard",
        "group": "config-group",
        "order": 4,
        "width": "6",
        "height": "1",
        "passthru": true,
        "multiple": false,
        "options": [
            {"label": "ğŸ“Š All Members", "value": "ALL", "type": "str"},
            {"label": "ğŸ‘´ PapÃ¡ - Roberto", "value": "XIAOMI-PAPA-001", "type": "str"},
            {"label": "ğŸ‘µ MamÃ¡ - Elena", "value": "APPLE-MAMA-002", "type": "str"},
            {"label": "ğŸ‘¨â€ğŸ¦³ Abuelo - JosÃ©", "value": "FITBIT-ABUELO-003", "type": "str"},
            {"label": "ğŸ”§ Test Simulator", "value": "SIM-NODERED-004", "type": "str"}
        ],
        "payload": "",
        "topic": "config/selected",
        "topicType": "str",
        "x": 170,
        "y": 340,
        "wires": [["set-selected-device"]]
    },
    {
        "id": "reset-steps-btn",
        "type": "ui_button",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ”„ Reset Steps",
        "group": "config-group",
        "order": 5,
        "width": "3",
        "height": "1",
        "passthru": false,
        "label": "Reset Steps",
        "tooltip": "Reset step counters for all devices to 0",
        "color": "",
        "bgcolor": "#607D8B",
        "className": "",
        "icon": "fa-undo",
        "payload": "reset",
        "payloadType": "str",
        "topic": "control/reset",
        "topicType": "str",
        "x": 150,
        "y": 400,
        "wires": [["do-reset-steps"]]
    },
    {
        "id": "set-emission-state",
        "type": "function",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ’¾ Set Emission State",
        "func": "global.set('emissionEnabled', msg.payload);\nnode.status({fill: msg.payload ? 'green' : 'red', shape: 'dot', text: msg.payload ? 'ON' : 'OFF'});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 160,
        "wires": [[]]
    },
    {
        "id": "status-emission",
        "type": "function",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ“ Format Status",
        "func": "const enabled = msg.payload;\nmsg.payload = enabled ? 'â–¶ï¸ Emitting data...' : 'â¹ï¸ Emission stopped';\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 200,
        "wires": [["emission-status-text"]]
    },
    {
        "id": "update-interval",
        "type": "function",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ“ Update Interval",
        "func": "global.set('emissionInterval', msg.payload);\nnode.status({fill:'blue', shape:'dot', text: msg.payload + 'ms'});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 220,
        "wires": [[]]
    },
    {
        "id": "set-anomaly-mode",
        "type": "function",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ’¾ Set Anomaly Mode",
        "func": "global.set('anomalyMode', msg.payload);\nnode.status({fill: msg.payload ? 'yellow' : 'grey', shape: 'dot', text: msg.payload ? 'ACTIVE' : 'OFF'});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 280,
        "wires": [[]]
    },
    {
        "id": "set-selected-device",
        "type": "function",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ’¾ Set Selected Device",
        "func": "global.set('selectedDevice', msg.payload);\nnode.status({fill:'blue', shape:'dot', text: msg.payload});\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 340,
        "wires": [[]]
    },
    {
        "id": "do-reset-steps",
        "type": "function",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ”„ Reset All Steps",
        "func": "// Reset step counters for all devices\nglobal.set('steps_XIAOMI-PAPA-001', 0);\nglobal.set('steps_APPLE-MAMA-002', 0);\nglobal.set('steps_FITBIT-ABUELO-003', 0);\nglobal.set('steps_SIM-NODERED-004', 0);\n\nnode.status({fill:'green', shape:'dot', text: 'Steps reset âœ“'});\n\n// Send notification\nmsg.payload = 'ğŸ”„ All step counters reset to 0';\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 400,
        "wires": [["reset-notification"]]
    },
    {
        "id": "reset-notification",
        "type": "ui_toast",
        "z": "vitalsync-flow-tab",
        "name": "Reset Toast",
        "position": "top right",
        "displayTime": "3",
        "highlight": "",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "className": "",
        "topic": "",
        "x": 610,
        "y": 400,
        "wires": []
    },
    {
        "id": "comment-data-flow",
        "type": "comment",
        "z": "vitalsync-flow-tab",
        "name": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DATA GENERATION FLOW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        "info": "",
        "x": 280,
        "y": 460,
        "wires": []
    },
    {
        "id": "interval-trigger",
        "type": "inject",
        "z": "vitalsync-flow-tab",
        "name": "â° 1s Interval (default)",
        "props": [{"p": "payload"}],
        "repeat": "1",
        "crontab": "",
        "once": true,
        "onceDelay": 3,
        "topic": "",
        "payload": "tick",
        "payloadType": "str",
        "x": 180,
        "y": 520,
        "wires": [["emission-gate"]]
    },
    {
        "id": "emission-gate",
        "type": "function",
        "z": "vitalsync-flow-tab",
        "name": "ğŸš¦ Emission Gate",
        "func": "// Check if emission is enabled\nconst emissionEnabled = global.get('emissionEnabled') || false;\n\nif (emissionEnabled) {\n    return msg;\n}\n\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "// Initialize global state\nglobal.set('emissionEnabled', false);\nglobal.set('anomalyMode', false);\nglobal.set('selectedDevice', 'ALL');\nglobal.set('emissionInterval', 1000);\n\n// Initialize step counters\nglobal.set('steps_XIAOMI-PAPA-001', Math.floor(Math.random() * 1000));\nglobal.set('steps_APPLE-MAMA-002', Math.floor(Math.random() * 1500));\nglobal.set('steps_FITBIT-ABUELO-003', Math.floor(Math.random() * 500));\nglobal.set('steps_SIM-NODERED-004', 0);\n\n// Set API URL from environment or default\nconst apiUrl = env.get('API_URL') || 'http://vitalsync-api:8000';\nglobal.set('apiUrl', apiUrl);",
        "finalize": "",
        "libs": [],
        "x": 410,
        "y": 520,
        "wires": [["generate-vitals"]]
    },
    {
        "id": "generate-vitals",
        "type": "function",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ§¬ Generate Vital Signs",
        "func": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// VITALSYNC - Vital Signs Generator\n// Generates realistic health data for 4 simulated family members\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n// Family member profiles based on VitalSync Product Design\nconst PROFILES = {\n    'XIAOMI-PAPA-001': {\n        deviceId: 'XIAOMI-PAPA-001',\n        memberId: 'familia-garcia-papa',\n        memberName: 'Roberto GarcÃ­a',\n        relationship: 'padre',\n        deviceType: 'xiaomi_mi_band',\n        // Profile: Male, 52 years, controlled hypertension\n        heartRate: { min: 65, max: 85, baseline: 72 },\n        oxygenLevel: { min: 95, max: 99, baseline: 96.5 },\n        bodyTemperature: { min: 36.2, max: 37.0, baseline: 36.5 },\n        stepsPerInterval: { min: 5, max: 25 }\n    },\n    'APPLE-MAMA-002': {\n        deviceId: 'APPLE-MAMA-002',\n        memberId: 'familia-garcia-mama',\n        memberName: 'Elena GarcÃ­a',\n        relationship: 'madre',\n        deviceType: 'apple_watch',\n        // Profile: Female, 48 years, type 2 diabetic\n        heartRate: { min: 60, max: 80, baseline: 68 },\n        oxygenLevel: { min: 96, max: 99, baseline: 98 },\n        bodyTemperature: { min: 36.4, max: 37.2, baseline: 36.8 },\n        stepsPerInterval: { min: 8, max: 30 }\n    },\n    'FITBIT-ABUELO-003': {\n        deviceId: 'FITBIT-ABUELO-003',\n        memberId: 'familia-garcia-abuelo',\n        memberName: 'JosÃ© GarcÃ­a Sr.',\n        relationship: 'abuelo',\n        deviceType: 'fitbit',\n        // Profile: Male, 78 years, pacemaker, arrhythmia history\n        heartRate: { min: 55, max: 75, baseline: 62 },\n        oxygenLevel: { min: 92, max: 97, baseline: 94 },\n        bodyTemperature: { min: 36.0, max: 36.8, baseline: 36.3 },\n        stepsPerInterval: { min: 2, max: 10 }\n    },\n    'SIM-NODERED-004': {\n        deviceId: 'SIM-NODERED-004',\n        memberId: 'familia-garcia-sim',\n        memberName: 'Test Simulator',\n        relationship: 'otro',\n        deviceType: 'simulator',\n        // Profile: Test device with wider ranges\n        heartRate: { min: 60, max: 100, baseline: 75 },\n        oxygenLevel: { min: 94, max: 99, baseline: 97 },\n        bodyTemperature: { min: 36.0, max: 37.5, baseline: 36.6 },\n        stepsPerInterval: { min: 0, max: 50 }\n    }\n};\n\n// Gaussian random number generator for realistic variation\nfunction gaussianRandom(mean, stdDev) {\n    let u = 0, v = 0;\n    while (u === 0) u = Math.random();\n    while (v === 0) v = Math.random();\n    const num = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);\n    return num * stdDev + mean;\n}\n\n// Random integer in range\nfunction randomInt(min, max) {\n    return Math.floor(Math.random() * (max - min + 1)) + min;\n}\n\n// Get anomaly mode\nconst anomalyMode = global.get('anomalyMode') || false;\n\n// Generate data for each device\nconst messages = [];\nconst deviceIds = Object.keys(PROFILES);\n\nfor (const deviceId of deviceIds) {\n    const profile = PROFILES[deviceId];\n    const now = new Date();\n    \n    // Generate base values with natural variation (gaussian distribution)\n    let heartRate = gaussianRandom(\n        profile.heartRate.baseline,\n        (profile.heartRate.max - profile.heartRate.min) / 6\n    );\n    \n    let oxygenLevel = gaussianRandom(\n        profile.oxygenLevel.baseline,\n        (profile.oxygenLevel.max - profile.oxygenLevel.min) / 6\n    );\n    \n    let bodyTemperature = gaussianRandom(\n        profile.bodyTemperature.baseline,\n        (profile.bodyTemperature.max - profile.bodyTemperature.min) / 6\n    );\n    \n    // Inject anomaly if enabled (30% probability)\n    let isAnomaly = false;\n    if (anomalyMode && Math.random() < 0.30) {\n        isAnomaly = true;\n        const anomalyTypes = ['hr_high', 'hr_low', 'spo2_low', 'temp_high', 'temp_low'];\n        const anomalyType = anomalyTypes[randomInt(0, anomalyTypes.length - 1)];\n        \n        switch (anomalyType) {\n            case 'hr_high':  // Tachycardia\n                heartRate = randomInt(125, 145);\n                break;\n            case 'hr_low':   // Bradycardia\n                heartRate = randomInt(38, 48);\n                break;\n            case 'spo2_low': // Hypoxemia\n                oxygenLevel = randomInt(82, 88);\n                break;\n            case 'temp_high': // High fever\n                bodyTemperature = 38.5 + Math.random() * 1.5;\n                break;\n            case 'temp_low':  // Hypothermia\n                bodyTemperature = 33.5 + Math.random() * 1;\n                break;\n        }\n    }\n    \n    // Get and update accumulated steps\n    const stepsKey = 'steps_' + deviceId;\n    let currentSteps = global.get(stepsKey) || 0;\n    const stepsIncrement = randomInt(\n        profile.stepsPerInterval.min,\n        profile.stepsPerInterval.max\n    );\n    currentSteps += stepsIncrement;\n    global.set(stepsKey, currentSteps);\n    \n    // Build payload according to API schema (no deviceType field)\n    const payload = {\n        deviceId: profile.deviceId,\n        memberId: profile.memberId,\n        memberName: profile.memberName,\n        relationship: profile.relationship,\n        heartRate: Math.round(Math.max(30, Math.min(200, heartRate))),\n        oxygenLevel: parseFloat(Math.max(50, Math.min(100, oxygenLevel)).toFixed(1)),\n        bodyTemperature: parseFloat(Math.max(32, Math.min(42, bodyTemperature)).toFixed(2)),\n        steps: currentSteps,\n        timestamp: now.toISOString(),\n        isAnomaly: isAnomaly\n    };\n    \n    messages.push({\n        payload: payload,\n        topic: 'vitals/' + deviceId,\n        deviceId: deviceId\n    });\n}\n\n// Return array of messages (one per device)\nreturn [messages];",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 520,
        "wires": [["split-messages"]]
    },
    {
        "id": "split-messages",
        "type": "split",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ“¤ Split by Device",
        "splt": "\\n",
        "spltType": "str",
        "arraySplt": 1,
        "arraySpltType": "len",
        "stream": false,
        "addname": "",
        "x": 870,
        "y": 520,
        "wires": [["prepare-http-request", "update-dashboard", "check-alerts"]]
    },
    {
        "id": "comment-api-section",
        "type": "comment",
        "z": "vitalsync-flow-tab",
        "name": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• API COMMUNICATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        "info": "",
        "x": 270,
        "y": 580,
        "wires": []
    },
    {
        "id": "prepare-http-request",
        "type": "function",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ“‹ Prepare HTTP Request",
        "func": "// Get API URL from global context or use default\nconst apiUrl = global.get('apiUrl') || 'http://vitalsync-api:8000';\n\n// Set the URL for the HTTP request node\nmsg.url = apiUrl + '/api/vitals';\n\n// Ensure headers are set\nmsg.headers = {\n    'Content-Type': 'application/json'\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1110,
        "y": 440,
        "wires": [["http-post-vitals"]]
    },
    {
        "id": "http-post-vitals",
        "type": "http request",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ“¡ POST /api/vitals",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": true,
        "headers": [],
        "x": 1330,
        "y": 440,
        "wires": [["handle-response"]]
    },
    {
        "id": "handle-response",
        "type": "function",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ“‹ Handle Response",
        "func": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// HEALTH INDICATOR - Shows API connection status\n// Required by project: \"visual cue when the last POST succeeded\"\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst statusCode = msg.statusCode || 0;\nconst now = new Date().toLocaleTimeString('es-MX');\nlet statusMsg = '';\nlet statusColor = 'green';\nlet toastMsg = null;\n\nswitch (true) {\n    case (statusCode === 200 || statusCode === 201):\n        statusMsg = `âœ… OK (${statusCode}) - ${now}`;\n        statusColor = 'green';\n        break;\n    case (statusCode === 400):\n        statusMsg = `âš ï¸ Bad Request (400) - ${now}`;\n        statusColor = 'yellow';\n        toastMsg = 'âš ï¸ API returned Bad Request (400)';\n        break;\n    case (statusCode === 401):\n        statusMsg = `ğŸ”’ Unauthorized (401) - ${now}`;\n        statusColor = 'red';\n        toastMsg = 'ğŸ”’ API authentication failed (401)';\n        break;\n    case (statusCode === 404):\n        statusMsg = `â“ Not Found (404) - ${now}`;\n        statusColor = 'red';\n        toastMsg = 'â“ API endpoint not found (404)';\n        break;\n    case (statusCode >= 500):\n        statusMsg = `âŒ Server Error (${statusCode}) - ${now}`;\n        statusColor = 'red';\n        toastMsg = `âŒ API Server Error (${statusCode})`;\n        break;\n    case (statusCode === 0):\n        statusMsg = `â±ï¸ No Response - ${now}`;\n        statusColor = 'grey';\n        toastMsg = 'â±ï¸ API not responding - check connection';\n        break;\n    default:\n        statusMsg = `â“ Unknown (${statusCode}) - ${now}`;\n        statusColor = 'grey';\n}\n\nnode.status({fill: statusColor, shape: 'dot', text: statusMsg});\n\n// Output 1: Status text for dashboard\nconst statusOutput = { payload: statusMsg };\n\n// Output 2: Toast notification (only for errors)\nconst toastOutput = toastMsg ? { payload: toastMsg } : null;\n\nreturn [statusOutput, toastOutput];",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1530,
        "y": 440,
        "wires": [["connection-status-text"], ["error-toast"]]
    },
    {
        "id": "error-toast",
        "type": "ui_toast",
        "z": "vitalsync-flow-tab",
        "name": "Error Toast",
        "position": "top right",
        "displayTime": "5",
        "highlight": "true",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "className": "",
        "topic": "",
        "x": 1730,
        "y": 480,
        "wires": []
    },
    {
        "id": "comment-dashboard-section",
        "type": "comment",
        "z": "vitalsync-flow-tab",
        "name": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD UPDATES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        "info": "",
        "x": 270,
        "y": 640,
        "wires": []
    },
    {
        "id": "update-dashboard",
        "type": "function",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ“Š Filter for Dashboard",
        "func": "// Get selected device filter\nconst selectedDevice = global.get('selectedDevice') || 'ALL';\nconst deviceId = msg.payload.deviceId;\nconst data = msg.payload;\n\n// Check if this device should be displayed\nif (selectedDevice !== 'ALL' && selectedDevice !== deviceId) {\n    return [null, null, null, null, null];\n}\n\n// Create separate messages for each dashboard widget\n// Output 1: Heart Rate for gauge\nconst hrMsg = { \n    payload: data.heartRate, \n    topic: data.memberName,\n    deviceId: deviceId \n};\n\n// Output 2: Oxygen Level for gauge\nconst spo2Msg = { \n    payload: data.oxygenLevel, \n    topic: data.memberName,\n    deviceId: deviceId \n};\n\n// Output 3: Temperature for chart (with series label)\nconst tempMsg = { \n    payload: data.bodyTemperature,\n    topic: data.memberName,\n    deviceId: deviceId\n};\n\n// Output 4: Steps for text display\nconst stepsMsg = { \n    payload: data.steps, \n    topic: data.memberName,\n    deviceId: deviceId \n};\n\n// Output 5: Raw data for debug\nconst rawMsg = { \n    payload: data, \n    topic: 'raw' \n};\n\nreturn [hrMsg, spo2Msg, tempMsg, stepsMsg, rawMsg];",
        "outputs": 5,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1110,
        "y": 600,
        "wires": [["hr-gauge"], ["spo2-gauge"], ["temp-chart"], ["steps-text"], ["debug-raw"]]
    },
    {
        "id": "hr-gauge",
        "type": "ui_gauge",
        "z": "vitalsync-flow-tab",
        "name": "â¤ï¸ Heart Rate",
        "group": "vitals-group",
        "order": 1,
        "width": "3",
        "height": "3",
        "gtype": "gage",
        "title": "Heart Rate",
        "label": "bpm",
        "format": "{{value}}",
        "min": 40,
        "max": 150,
        "colors": ["#F44336", "#4CAF50", "#F44336"],
        "seg1": "60",
        "seg2": "100",
        "diff": false,
        "className": "",
        "x": 1350,
        "y": 560,
        "wires": []
    },
    {
        "id": "spo2-gauge",
        "type": "ui_gauge",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ« Oxygen Level",
        "group": "vitals-group",
        "order": 2,
        "width": "3",
        "height": "3",
        "gtype": "gage",
        "title": "SpO2",
        "label": "%",
        "format": "{{value}}",
        "min": 80,
        "max": 100,
        "colors": ["#F44336", "#FF9800", "#4CAF50"],
        "seg1": "90",
        "seg2": "95",
        "diff": false,
        "className": "",
        "x": 1360,
        "y": 600,
        "wires": []
    },
    {
        "id": "temp-chart",
        "type": "ui_chart",
        "z": "vitalsync-flow-tab",
        "name": "ğŸŒ¡ï¸ Temperature Chart",
        "group": "chart-group",
        "order": 1,
        "width": "12",
        "height": "4",
        "label": "Body Temperature (Â°C) - Rolling 2 minutes",
        "chartType": "line",
        "legend": "true",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "Waiting for data...",
        "dot": true,
        "ymin": "35",
        "ymax": "40",
        "removeOlder": "2",
        "removeOlderPoints": "",
        "removeOlderUnit": "60",
        "cutout": 0,
        "useOneColor": false,
        "useUTC": false,
        "colors": ["#2196F3", "#4CAF50", "#FF9800", "#9C27B0"],
        "outputs": 1,
        "useDifferentColor": false,
        "className": "",
        "x": 1370,
        "y": 640,
        "wires": [[]]
    },
    {
        "id": "steps-text",
        "type": "ui_text",
        "z": "vitalsync-flow-tab",
        "name": "ğŸš¶ Steps",
        "group": "status-group",
        "order": 1,
        "width": "3",
        "height": "1",
        "label": "ğŸš¶ Steps:",
        "format": "{{msg.payload | number}}",
        "layout": "row-spread",
        "className": "",
        "x": 1340,
        "y": 680,
        "wires": []
    },
    {
        "id": "debug-raw",
        "type": "debug",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ” Debug Data",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": true,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "payload.memberName",
        "statusType": "msg",
        "x": 1350,
        "y": 720,
        "wires": []
    },
    {
        "id": "emission-status-text",
        "type": "ui_text",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ“¡ Emission Status",
        "group": "status-group",
        "order": 2,
        "width": "3",
        "height": "1",
        "label": "Status:",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "className": "",
        "x": 630,
        "y": 200,
        "wires": []
    },
    {
        "id": "connection-status-text",
        "type": "ui_text",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ”— API Status",
        "group": "status-group",
        "order": 3,
        "width": "6",
        "height": "1",
        "label": "API:",
        "format": "{{msg.payload}}",
        "layout": "row-spread",
        "className": "",
        "x": 1730,
        "y": 440,
        "wires": []
    },
    {
        "id": "comment-alerts-section",
        "type": "comment",
        "z": "vitalsync-flow-tab",
        "name": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ALERTS SYSTEM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        "info": "",
        "x": 260,
        "y": 760,
        "wires": []
    },
    {
        "id": "check-alerts",
        "type": "function",
        "z": "vitalsync-flow-tab",
        "name": "ğŸš¨ Check Thresholds",
        "func": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ALERT SYSTEM - Checks vital signs against thresholds\n// Based on VitalSync Product Design document\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst data = msg.payload;\nconst alerts = [];\n\n// Thresholds from VitalSync Product Design\nconst THRESHOLDS = {\n    heartRate: {\n        critical_low: 50,\n        warning_low: 60,\n        warning_high: 100,\n        critical_high: 120\n    },\n    oxygenLevel: {\n        critical: 90,\n        warning: 95\n    },\n    bodyTemperature: {\n        critical_low: 35.0,\n        warning_low: 36.1,\n        warning_high: 37.2,\n        critical_high: 38.0\n    }\n};\n\n// Check Heart Rate\nif (data.heartRate < THRESHOLDS.heartRate.critical_low) {\n    alerts.push({\n        level: 'CRITICAL',\n        icon: 'ğŸ”´',\n        metric: 'Heart Rate',\n        value: data.heartRate,\n        unit: 'bpm',\n        message: `${data.memberName}: Bradycardia - HR ${data.heartRate} bpm (critical <${THRESHOLDS.heartRate.critical_low})`\n    });\n} else if (data.heartRate > THRESHOLDS.heartRate.critical_high) {\n    alerts.push({\n        level: 'CRITICAL',\n        icon: 'ğŸ”´',\n        metric: 'Heart Rate',\n        value: data.heartRate,\n        unit: 'bpm',\n        message: `${data.memberName}: Tachycardia - HR ${data.heartRate} bpm (critical >${THRESHOLDS.heartRate.critical_high})`\n    });\n} else if (data.heartRate < THRESHOLDS.heartRate.warning_low) {\n    alerts.push({\n        level: 'WARNING',\n        icon: 'âš ï¸',\n        metric: 'Heart Rate',\n        value: data.heartRate,\n        unit: 'bpm',\n        message: `${data.memberName}: Low HR ${data.heartRate} bpm`\n    });\n} else if (data.heartRate > THRESHOLDS.heartRate.warning_high) {\n    alerts.push({\n        level: 'WARNING',\n        icon: 'âš ï¸',\n        metric: 'Heart Rate',\n        value: data.heartRate,\n        unit: 'bpm',\n        message: `${data.memberName}: Elevated HR ${data.heartRate} bpm`\n    });\n}\n\n// Check Oxygen Level\nif (data.oxygenLevel < THRESHOLDS.oxygenLevel.critical) {\n    alerts.push({\n        level: 'CRITICAL',\n        icon: 'ğŸ”´',\n        metric: 'Oxygen',\n        value: data.oxygenLevel,\n        unit: '%',\n        message: `${data.memberName}: Hypoxemia - SpO2 ${data.oxygenLevel}% (critical <${THRESHOLDS.oxygenLevel.critical}%)`\n    });\n} else if (data.oxygenLevel < THRESHOLDS.oxygenLevel.warning) {\n    alerts.push({\n        level: 'WARNING',\n        icon: 'âš ï¸',\n        metric: 'Oxygen',\n        value: data.oxygenLevel,\n        unit: '%',\n        message: `${data.memberName}: Low SpO2 ${data.oxygenLevel}%`\n    });\n}\n\n// Check Temperature\nif (data.bodyTemperature < THRESHOLDS.bodyTemperature.critical_low) {\n    alerts.push({\n        level: 'CRITICAL',\n        icon: 'ğŸ”´',\n        metric: 'Temperature',\n        value: data.bodyTemperature,\n        unit: 'Â°C',\n        message: `${data.memberName}: Hypothermia - ${data.bodyTemperature}Â°C`\n    });\n} else if (data.bodyTemperature > THRESHOLDS.bodyTemperature.critical_high) {\n    alerts.push({\n        level: 'CRITICAL',\n        icon: 'ğŸ”´',\n        metric: 'Temperature',\n        value: data.bodyTemperature,\n        unit: 'Â°C',\n        message: `${data.memberName}: High Fever - ${data.bodyTemperature}Â°C`\n    });\n} else if (data.bodyTemperature < THRESHOLDS.bodyTemperature.warning_low) {\n    alerts.push({\n        level: 'WARNING',\n        icon: 'âš ï¸',\n        metric: 'Temperature',\n        value: data.bodyTemperature,\n        unit: 'Â°C',\n        message: `${data.memberName}: Low temp ${data.bodyTemperature}Â°C`\n    });\n} else if (data.bodyTemperature > THRESHOLDS.bodyTemperature.warning_high) {\n    alerts.push({\n        level: 'WARNING',\n        icon: 'âš ï¸',\n        metric: 'Temperature',\n        value: data.bodyTemperature,\n        unit: 'Â°C',\n        message: `${data.memberName}: Elevated temp ${data.bodyTemperature}Â°C`\n    });\n}\n\n// If there are alerts, send them\nif (alerts.length > 0) {\n    node.status({fill: 'red', shape: 'dot', text: `${alerts.length} alert(s)`});\n    return { payload: alerts, topic: 'alerts', deviceId: data.deviceId };\n}\n\nnode.status({fill: 'green', shape: 'dot', text: 'All normal'});\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1110,
        "y": 800,
        "wires": [["format-alert", "alert-toast"]]
    },
    {
        "id": "format-alert",
        "type": "function",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ“‹ Format Alert Display",
        "func": "const alerts = msg.payload;\nconst now = new Date().toLocaleTimeString('es-MX');\n\n// Format for display in alert log\nlet html = '<div style=\"max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;\">';\n\nfor (const alert of alerts) {\n    const bgColor = alert.level === 'CRITICAL' ? '#ffcdd2' : '#fff9c4';\n    html += `<div style=\"background: ${bgColor}; padding: 5px; margin: 2px 0; border-radius: 4px;\">`;\n    html += `${alert.icon} <strong>${alert.level}</strong> [${now}]<br>`;\n    html += `${alert.message}`;\n    html += '</div>';\n}\n\nhtml += '</div>';\n\nmsg.payload = html;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1350,
        "y": 800,
        "wires": [["alert-log"]]
    },
    {
        "id": "alert-toast",
        "type": "ui_toast",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ”” Alert Toast",
        "position": "top right",
        "displayTime": "5",
        "highlight": "true",
        "sendall": true,
        "outputs": 0,
        "ok": "OK",
        "cancel": "",
        "raw": false,
        "className": "",
        "topic": "",
        "x": 1340,
        "y": 840,
        "wires": []
    },
    {
        "id": "alert-log",
        "type": "ui_template",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ“œ Alert Log",
        "group": "alerts-group",
        "order": 1,
        "width": "6",
        "height": "4",
        "format": "<div ng-bind-html=\"msg.payload\"></div>",
        "storeOutMessages": true,
        "fwdInMessages": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 1570,
        "y": 800,
        "wires": [[]]
    },
    {
        "id": "comment-config-section",
        "type": "comment",
        "z": "vitalsync-flow-tab",
        "name": "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• API CONFIGURATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•",
        "info": "Configure the API URL here. Options:\n\n1. Docker Compose: http://vitalsync-api:8000\n2. Local development: http://localhost:8000\n3. AWS deployed: https://your-api-url.com\n\nSet via environment variable API_URL or modify the 'Set API URL' node.",
        "x": 270,
        "y": 880,
        "wires": []
    },
    {
        "id": "set-api-url-btn",
        "type": "inject",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ”§ Set API URL on Start",
        "props": [{"p": "payload"}],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.5,
        "topic": "",
        "payload": "init",
        "payloadType": "str",
        "x": 190,
        "y": 940,
        "wires": [["set-api-url"]]
    },
    {
        "id": "set-api-url",
        "type": "function",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ”§ Set API URL",
        "func": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// API URL CONFIGURATION\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// Priority:\n// 1. Environment variable API_URL\n// 2. Docker internal: http://vitalsync-api:8000\n// 3. Fallback: http://localhost:8000\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet apiUrl;\n\n// Try to get from environment variable\nconst envUrl = env.get('API_URL');\n\nif (envUrl) {\n    apiUrl = envUrl;\n} else {\n    // Default for Docker Compose setup\n    apiUrl = 'http://vitalsync-api:8000';\n}\n\n// Store in global context\nglobal.set('apiUrl', apiUrl);\n\nnode.status({fill: 'blue', shape: 'dot', text: apiUrl});\nnode.warn('API URL configured: ' + apiUrl);\n\nmsg.payload = 'API URL set to: ' + apiUrl;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 940,
        "wires": [[]]
    },
    {
        "id": "manual-api-url",
        "type": "ui_text_input",
        "z": "vitalsync-flow-tab",
        "name": "API URL Input",
        "label": "API URL:",
        "tooltip": "Enter API URL (e.g., http://localhost:8000)",
        "group": "config-group",
        "order": 6,
        "width": "6",
        "height": "1",
        "passthru": true,
        "mode": "text",
        "delay": "0",
        "topic": "config/apiUrl",
        "sendOnBlur": true,
        "className": "",
        "topicType": "str",
        "x": 170,
        "y": 1000,
        "wires": [["save-manual-api-url"]]
    },
    {
        "id": "save-manual-api-url",
        "type": "function",
        "z": "vitalsync-flow-tab",
        "name": "ğŸ’¾ Save API URL",
        "func": "if (msg.payload && msg.payload.length > 0) {\n    let url = msg.payload.trim();\n    // Add https:// if no protocol specified\n    if (!url.startsWith('http://') && !url.startsWith('https://')) {\n        url = 'https://' + url;\n    }\n    global.set('apiUrl', url);\n    node.status({fill: 'green', shape: 'dot', text: 'Saved: ' + url});\n    node.warn('API URL manually set to: ' + url);\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 1000,
        "wires": [[]]
    }
]
